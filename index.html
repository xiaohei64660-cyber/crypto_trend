<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Web3 Trading Platform</title>
  <meta name="dapp" content="true">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      margin: 0;
      min-height: 100vh;
      background: #0f111a;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      color: #e0e0e0;
      padding: 0;
      position: relative;
    }
    .app-container {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding-bottom: 60px;
    }
    .header {
      position: relative;
      padding: 16px;
      text-align: center;
      color: white;
    }
    .customer-service {
      position: absolute;
      top: 16px;
      right: 16px;
      font-size: 24px;
      cursor: pointer;
    }
    .card {
      background: #161a24;
      padding: 20px;
      margin: 12px;
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.3);
      text-align: center;
    }
    h1 {
      font-size: 22px;
      margin: 0 0 12px;
      color: #fff;
    }
    .btn {
      display: block;
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin: 8px 0;
    }
    .primary { background: #3b82f6; color: white; }
    .secondary { background: #222; color: #fff; }
    .address {
      font-family: monospace;
      background: #0f131b;
      padding: 10px;
      border-radius: 8px;
      margin: 10px 0;
      font-size: 13px;
      word-break: break-all;
      color: #fff;
    }
    .network {
      display: inline-block;
      background: #22c55e;
      color: #000;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      margin: 8px 0;
    }
    .balance {
      margin: 8px 0;
      font-size: 15px;
      color: #ddd;
    }
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #161a24;
      display: flex;
      justify-content: space-around;
      padding: 10px 0;
      border-top: 1px solid #2a2f3a;
    }
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 10px;
      color: #aaa;
      text-decoration: none;
      width: 20%;
    }
    .nav-item.active {
      color: #3b82f6;
    }
    .nav-icon {
      font-size: 20px;
      margin-bottom: 4px;
    }
    .trade-center {
      background: #3b82f6;
      color: white;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: -20px;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }
    .trade-center .nav-icon {
      font-size: 24px;
    }
    .trade-center .nav-label {
      display: none;
    }
    .init-screen {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 80vh;
      padding: 20px;
      text-align: center;
    }
    .init-screen h1 {
      font-size: 24px;
      margin-bottom: 16px;
    }
    .init-screen p {
      color: #aaa;
      margin-bottom: 28px;
      line-height: 1.5;
    }
  </style>
</head>
<body>
  <!-- Customer Service Icon -->
  <div class="customer-service" onclick="openSupport()">üí¨</div>

  <div class="app-container">
    <!-- Initial Screen -->
    <div class="init-screen" id="initScreen">
      <h1>Web3 Trading Platform</h1>
      <p>Connect your wallet to trade crypto securely.</p>
      <button class="btn primary" id="connectBtn">Connect Your Wallet</button>
    </div>

    <!-- Portfolio Screen (Homepage) -->
    <div class="card" id="portfolioScreen" style="display:none;">
      <h1>Portfolio</h1>
      <div class="address" id="userAddress">0x...</div>
      <div class="network" id="networkName">‚Äî</div>
      <div class="balance" id="nativeBalance">ETH: ‚Äî</div>
      <div class="balance" id="usdcBalance">USDC: ‚Äî</div>
      <div class="balance" id="creditPointsEl">Credit Points: 0</div>
      <button class="btn primary" id="swapBtn">Swap Tokens</button>
      <button class="btn secondary" id="withdrawBtn" disabled>Withdraw (Disabled)</button>
      <button class="btn secondary" onclick="handleDisconnect()">Disconnect</button>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <div class="bottom-nav">
    <a href="#" class="nav-item active">
      <div class="nav-icon">üè†</div>
      <div class="nav-label">Home</div>
    </a>
    <a href="#" class="nav-item">
      <div class="nav-icon">üìä</div>
      <div class="nav-label">Market</div>
    </a>
    <div class="trade-center" onclick="showSwap()">
      <div class="nav-icon">üí±</div>
      <div class="nav-label">Trade</div>
    </div>
    <a href="#" class="nav-item">
      <div class="nav-icon">üìú</div>
      <div class="nav-label">Transactions</div>
    </a>
    <a href="#" class="nav-item">
      <div class="nav-icon">üë§</div>
      <div class="nav-label">User</div>
    </a>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
  <script>
    // Global variables
    let provider, signer, userAddress, currentChainId;

    // DOM elements
    const initScreen = document.getElementById('initScreen');
    const portfolioScreen = document.getElementById('portfolioScreen');
    const connectBtn = document.getElementById('connectBtn');
    const userAddressEl = document.getElementById('userAddress');
    const networkNameEl = document.getElementById('networkName');
    const nativeBalanceEl = document.getElementById('nativeBalance');
    const usdcBalanceEl = document.getElementById('usdcBalance');
    const swapBtn = document.getElementById('swapBtn');
    const withdrawBtn = document.getElementById('withdrawBtn');

    // ======================
    // AUTO-CONNECT ON REVISIT
    // ======================
    async function initApp() {
      // Check if user was previously connected
      const savedAddress = localStorage.getItem('web3_user_address');
      if (savedAddress) {
        try {
          await autoConnect(savedAddress);
          return;
        } catch (e) {
          console.log('Auto-connect failed, showing connect screen');
        }
      }
      // Show connect screen
      initScreen.style.display = 'flex';
      connectBtn.addEventListener('click', connectWallet);
    }

    async function autoConnect(savedAddress) {
      if (!window.ethereum) throw new Error('No wallet');
      
      // Request accounts silently
      const accounts = await window.ethereum.request({ method: 'eth_accounts' });
      if (accounts.length === 0) throw new Error('No accounts');
      
      const currentAddress = ethers.utils.getAddress(accounts[0]);
      if (currentAddress.toLowerCase() !== savedAddress.toLowerCase()) {
        throw new Error('Address mismatch');
      }
      
      userAddress = currentAddress;
      userAddressEl.textContent = userAddress;
      await setupProvider();
      showHomepage();
    }

    async function connectWallet() {
      if (!window.ethereum) {
        alert('Please use Trust Wallet dApp browser');
        return;
      }
      try {
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        userAddress = ethers.utils.getAddress(accounts[0]);
        userAddressEl.textContent = userAddress;
        localStorage.setItem('web3_user_address', userAddress); // Save for auto-connect
        await setupProvider();
        showHomepage();
      } catch (err) {
        alert('Connection failed');
      }
    }

    function showHomepage() {
      initScreen.style.display = 'none';
      portfolioScreen.style.display = 'block';
    }

    // ======================
    // WALLET & BALANCE LOGIC
    // ======================
    async function setupProvider() {
      provider = new ethers.providers.Web3Provider(window.ethereum);
      signer = provider.getSigner();
      const network = await provider.getNetwork();
      currentChainId = Number(network.chainId);

      const chainName = getChainName(currentChainId);
      networkNameEl.textContent = chainName;
      await updateBalances();
      await loadUserData();
    }

    function getChainName(id) {
      const names = {
        1: 'Ethereum', 137: 'Polygon', 56: 'BNB Chain',
        8453: 'Base', 42161: 'Arbitrum', 10: 'Optimism'
      };
      return names[id] || `Chain ${id}`;
    }

    async function updateBalances() {
      const symbol = getNativeSymbol(currentChainId);
      try {
        const ethBal = await provider.getBalance(userAddress);
        nativeBalanceEl.textContent = `${symbol}: ${parseFloat(ethers.utils.formatEther(ethBal)).toFixed(4)}`;
      } catch (e) {
        nativeBalanceEl.textContent = `${symbol}: ‚Äî`;
      }
    }

    function getNativeSymbol(id) {
      return {1: 'ETH', 137: 'MATIC', 56: 'BNB', 8453: 'ETH', 42161: 'ETH', 10: 'ETH'}[id] || 'ETH';
    }

    async function loadUserData() {
      try {
        const res = await fetch(`https://web3backend-production-2444.up.railway.app/api/user/${userAddress.toLowerCase()}`);
        const data = await res.json();
        
        // Credit Points
        document.getElementById('creditPointsEl').textContent = `Credit Points: ${data.creditPoints || 0}`;
        
        // Withdraw Button
        const canWithdraw = data.allowWithdraw !== false;
        withdrawBtn.textContent = canWithdraw ? 'Withdraw' : 'Withdraw (Disabled)';
        withdrawBtn.disabled = !canWithdraw;
        if (canWithdraw) {
          withdrawBtn.className = 'btn primary';
          withdrawBtn.onclick = () => alert('Withdraw feature coming soon!');
        } else {
          withdrawBtn.className = 'btn secondary';
          withdrawBtn.onclick = null;
        }
      } catch (e) {
        console.error('Failed to load user data');
      }
    }

    function handleDisconnect() {
      localStorage.removeItem('web3_user_address');
      provider = null; signer = null;
      portfolioScreen.style.display = 'none';
      initScreen.style.display = 'flex';
    }

    function showSwap() {
      alert('Swap screen coming soon!');
    }

    function openSupport() {
      alert('Customer support: support@yourdefi.app');
    }

    // Start the app
    initApp();
  </script>
</body>
</html>
